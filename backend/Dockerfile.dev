FROM golang:1.23.4-alpine

# Install build tools
RUN apk add --no-cache gcc musl-dev

# Set working directory
WORKDIR /go/src/bytecast

# Install Air for hot reload
RUN go install github.com/cosmtrek/air@v1.49.0

# Copy the entire backend directory
COPY . .

# Download dependencies
RUN go mod download

# Create tmp directory for air
RUN mkdir -p tmp

# Create .air.toml configuration
RUN echo '[build]' > .air.toml && \
    echo 'cmd = "go build -o ./tmp/main ./cmd/server/main.go"' >> .air.toml && \
    echo 'bin = "./tmp/main"' >> .air.toml && \
    echo 'include_ext = ["go", "mod"]' >> .air.toml && \
    echo 'exclude_dir = ["tmp", "vendor"]' >> .air.toml && \
    echo 'delay = 1000' >> .air.toml && \
    echo 'kill_delay = "0.5s"' >> .air.toml && \
    echo 'send_interrupt = true' >> .air.toml && \
    echo 'stop_on_error = true' >> .air.toml && \
    echo '[color]' >> .air.toml && \
    echo 'build = "yellow"' >> .air.toml && \
    echo 'main = "magenta"' >> .air.toml && \
    echo 'runner = "green"' >> .air.toml && \
    echo 'watcher = "cyan"' >> .air.toml

# Expose default port
EXPOSE 8080

# Using Air for hot reload in development
CMD ["air", "-c", ".air.toml"]
